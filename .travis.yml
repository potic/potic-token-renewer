sudo: required

language: java

services:
- docker

before_cache:
- rm -f  $HOME/.gradle/caches/modules-2/modules-2.lock
- rm -fr $HOME/.gradle/caches/*/plugin-resolution/

cache:
  directories:
  - "$HOME/.gradle/caches/"
  - "$HOME/.gradle/wrapper/"

before_install:
- openssl aes-256-cbc -K $encrypted_31331ec34363_key -iv $encrypted_31331ec34363_iv -in deployment_keys.tar.enc -out deployment_keys.tar -d
- tar xvf deployment_keys.tar
- chmod +x gradlew

install:
- "./gradlew build --scan -PpatchVersion=$TRAVIS_BUILD_NUMBER"

before_script:
- docker login -u="$DOCKER_USERNAME" -p="$DOCKER_PASSWORD"
- eval "$(ssh-agent -s)"
- chmod 600 deployment_keys/deploy_test
- ssh-add deployment_keys/deploy_test
- chmod 600 deployment_keys/deploy_prod
- ssh-add deployment_keys/deploy_prod

script:
- export DOCKER_REPO=potic/potic-token-renewer
- export TAG=`if [ "$TRAVIS_BRANCH" == "master" ]; then echo "latest"; else echo $TRAVIS_BRANCH | tr '/' '-' ; fi`
- export TAG_VERSION=`cat VERSION`.$TRAVIS_BUILD_NUMBER
- docker build -t $DOCKER_REPO:travis-$TRAVIS_BUILD_NUMBER .
- docker tag $DOCKER_REPO:travis-$TRAVIS_BUILD_NUMBER $DOCKER_REPO:$TAG
- docker tag $DOCKER_REPO:travis-$TRAVIS_BUILD_NUMBER $DOCKER_REPO:$TAG_VERSION
- docker push $DOCKER_REPO
- if [ "$TRAVIS_BRANCH" == "develop" ]; then ssh -o "StrictHostKeyChecking no" "$DEPLOY_TEST_USER"@"$DEPLOY_TEST_HOST" TAG_TO_DEPLOY=$TAG_VERSION ENVIRONMENT_NAME=test LOGZIO_TOKEN=$LOGZIO_TOKEN 'bash -s' < src/deploy/deploy.sh; fi
- if [ "$TRAVIS_BRANCH" == "master" ]; then ssh -o "StrictHostKeyChecking no" "$DEPLOY_PROD_USER"@"$DEPLOY_PROD_HOST" TAG_TO_DEPLOY=$TAG_VERSION ENVIRONMENT_NAME=prod LOGZIO_TOKEN=$LOGZIO_TOKEN 'bash -s' < src/deploy/deploy.sh; fi

env:
  global:
  - secure: oaX8hrM0wz5fC/YyA3GawaBvzVq6yLIJZUbPsuFQMZK90292BBK3C/1vqHXG8HRLUXIFOeYdzzFTtr3zRDIhYsUFxAtMwndSZNzGSp2vc+/xYQV6puE3oeTU04S2DdHOBASUdf9dMLjxOJZUEzwHwqFKTuB3B4AhxpSVODSuLseP98EQvJ2xEENu17sRxFBw4eiShsnDqJRlGGkhBTKwOhsJd3T/DCkAn6UbfI7Lr0aOCrQdMTo+XS95VtZeWbV9Hj8TQyFgY0Vtt63RAiqymDW9smGPG1wTHL5j4BvqPZ4467TY0IAfS/ApUW85EZGTuv5t3Z42HKhFhpQMp6WAWzaGiAoRfSym46jDdUQMcsNqaFoJ8iDgiyWexv0McFAGKyTi1iH4+ejK+K7NAJvaycexAokvMpiP/vPKSPf5qnrkHw9KbBiq3VyK+lBPPczRLBTCiXuxnQGgHTE9daS+q6zSqK57FeaVWZ8zH9RRXBPJCy08gtHP4CNRj1VzytmUAQn4qMTsblHAQjAQTOYFbFY+1qOXaA2SmsTZzf0P/JGqPrJZhSF7kHgXwFtgT6LJ0ZuDyMh7S7hlyLCgpHcohoR9Xdl4YNClknuqLP6vjFV4txQdOsLegYuZ+fv7y3T/YsRzJzK20ozsha8QNbnOkamuTXlZQoNvRKU3rxga1xI= # DOCKER_USERNAME
  - secure: IMn3vCmqU3WVl7prdL2TWaNGoSdqMm0FWBO4Si8wGbctMyy9dfGDV5vDNW2OxXSe78OccXkJKqsK7inplsgS5AMaJse7Uru87VyhkD6c/uB6D/H6gW3s0Q6XuQ7y1YfVGj+399jmy4BuizNhfpJ9D6fJyeQQPtDRqZAUDCRUGlyxW1kY1jpuMhTUq0Kmreka+y5UVLnir89KuDQQnA8MZjx4mEumEKLn0psmp4wqyyDXdKHjlX6fkAeib9NZG32onCGqJM3cXksGi4h2W8bYEBMryeDyk92Fbp+GEZALTAfc4Tsbd+pX/imtqhj430ZdYw89sQKriijTqXzuC/ctpE5y5rXOZjQTtluKoJ8DbtdsorQDgds6u/2kXHvCG9nVIT6Rid5g4gTJKMmOWR619D6Rjo40I8762XRWzQPlUB3DUJUDa75/blhUt9up5ln42cC4sco3SksQb88kHy3OCSue6Y0G7c6DEPy5gq7LnZ4T1C/lICkytWNuAgWNu9XFMcHq2fkXe3BilwuOzxvgGbrK6d1Mp8B91du/m8I4j6bvlQUr9Rwz2XD2+s5NJSli0laMzJv1qN3Gii2MEWyhR1Dlp+8HDyxO31K17WXSLTVGhALbywUYCxCwuW/WceT53wRqHYqStH1CFIk/3yDyaViQo3K7xZ2Ewo9AqeszrA8= # DOCKER_PASSWORD
  - secure: Puh5kSUezrsLh5TSKLoEVDSXFo0WIBtlTdn2Cm2qUV0zxAxAZ2mPIbbyMYyH6G4pZ/VYEKZ4rFrOjcBeC+DUfaVF6SYqp4jms/hsf8t9JffSlwexWMW3grgfjU9ZKIiZflH9C6Y23Up6EsUM/JBUD7C8YyLu+w8jPxeSfVMAlR2Ufo+RuddSWHPbQXuGCiU9Ls/dSXFcOMYtryfxIyorg2HpB68Yz16Drsqd2OO0BUzGKLkCwKidGMKSo2bttVOWFDw63kra/lk4NJDOsffDB6JpVagtQ4TGstvmq9+vqKKuZzenR+JgFvtOuFgZg0L278ELBWgFvvfjyOxXyITX19QCf6M8YjENbo5p1yQ5rR4Ld+yK3+H930CiUL4qNw5RW3Yxl0EZzMAWsC4BFHhKIBiQmbeJoaM1fC5BM14sPOEcULAuCV+Io/8+vl72PdYd7gprKNKDRFMVE0/i6zZpyMsmKW81RsPL/jJ9vvzHfzK/atgBTEZTBoFfrfoCWR/YbyfdJzSKmg4UcvhjOtrdLh84igJS/xv9XEGU0peadL5EB2D46ZbvNXJToi4Fr3nongax4afWqVJqqVgumiYRLzMivyIpv/FbyRdW+/PISlVqNx7uNJ9goGVPSLUg605B1Lb67S5xgMrAyLoBW1KNZa/OgKV2rS/E+W4AYWwi4qc= # DEPLOY_TEST_USER
  - secure: haH8JpKxhGoWCjiCH3kOXlsrwULYM0majVisx4iSr75qW51NOgrfKcG7xNbvyW8OWRUkbasJ+wTp/ThdsrYzrqmb+a7M7ajCMiK/7enZgQUjM3JOF9RT7Z2rEj5iFIIzH6rLjxmymq4cOldCx8v7PzMk+Wq7982Zl6cL2pzddsB4ik+v03+vkUxXFJ8yJ1TwY6P9p9D/WG8KH0MTUbMVqDo09W1vFKrPtUxxPFchzWI5zPi5Hq/QClVzVCH8t/9EWe+ob6gfOlVW8YQqWjmJ9TnbKKEquhI8qLsdwWJxjQH0XwF1W46R2cdJESSG3+zIecTQtz2QHIXLsWHS8Be+654eEbIHp/8F242ThQ/CHx2GxWNxQIOSEoV587MU2eISu+9goxZZ9uKw/99y3KLam3h12JxznJ/O4Xx8vF8fv74mZu/TO4mPSFqQ2Qx/WIQP8mmJGDUgfYrOOXmQRd5EpB0BE+gholBLMXrruygi+McW480OAzv8yrb3N/Dd3v69YEFZpzQICfkaEV4PmeenJ7QYFzmEIltSEgi6t/m6Zi+y/F1pSSPAnQxmQRjqGZVnsto7bjxg9R1MK7uZKgQ2h7iYobcPam2HYX11Kl2d1C9stadi+1rFX7safUhPeG8yQ/Ch72Bu2ZXtr6lCz1upckCl7dR1Xz/r6IumXwhQ53U= # DEPLOY_TEST_HOST
  - secure: SAGMiUrrHqDkrR6ZpyvM7s8PuGLFLlY5ED5ORAB59bX9xyNCiHJltuMZl3/fzdw7nrxBWcFT8zRasCgl/oGXB/4cA7JxCUr/fbDdmBOk1KvwwyTG/sQedZbLbDSxQFxTT8bKWXBy8AwOQNjxAH1zMRFpo6lo/qdsWoi5+0mTgqr6K/mF+nRWdTNPGFZaEK0uCyxAClRU9b7we/Yw1Jwzb7EPotIcFKM2oPUZUds4jqM/GTMEqr2uHNG90cui2cF+92fuOeTR1uAHSczPous4mRa4OW5reqQt8T01oPVD0FJ9ZgMf3GiRG3RQs6g1QoSZlZ0vHYk3imh2BOuJ654SCFaU7Q/7O+vkq964XIWan7a0gHsnKqwRj81pAaUe7jmVg4GKIIFVZtDyqU9xPlhGUmOmvRK63vGODMUh9xmUePjkjq9ZxZ59jFGBd9yAm3JcI/PC2J/5PA8+tc462xOIOdexXeSTrAI9jZh6hRe3vcl3FSRJidg5QMQqTjLiyB9q83BZ0PM12nb2StnK1/JYQzM6P9LASImS0AQsmaC3tVOfVcX35A6piRiDD0hvgMbDSJMd8HGJbPJ5sgPrB9dPD5r8uhybL/m1b78ICes4C1rbLiT+S1xRCmJAVGM3TC59JjuekFzsDhN7jl5gqA1WNhOiDsRhPtfPY5QzRonMYn4= # DEPLOY_PROD_USER
  - secure: RxIHTZvEVvhyVDJjxvwZcpv+TTnjyusL8qZgPYit5KCQlwvj5o7XC8TEENupb60fnsMPe2KCdZbMH7mQTXPKfwlSDxV5THXU8kmv5M+v+BrWu8S/mLZzIlQFdjQxVb+xqVTpkvAg8t5AH6Q3Yf7TFPoqK47wZ8AcEPKp0RdTLQkHZp/2jUoL6mAzH6MM3oV9CR3yPRR9zqHCfuArN4u+/R6aOPjtlfYsQPOavVydRJPURJ/rWu6n3XFcjGqSfdg3zow9IINmK/bv83g3StEeLEGZibhwvdfnmLhz6m/HfYuq13uKc3Kc9MUSVAr1RgkDp2EuR2YnYfQnjhK3RTVAItDzX58PuOhuYAPi6Cfwa5yTYHfx/rK1R7OFQKZ4wr8/ClsS+QsktaWdegMNVkPlfWMAPNV8SCauRiSLeaK75UYeUOuvm0tNjblrR4x2S8uzlIjv5HzqV+JVwEgwKqTKgRzbKMTQc09IKNE3+0ByN1stgeELDhqud5gDYJajJ1eW7jFp5w3j8ydpjSino9wQt/gwLXKmToHCY/0rzU/pivFX6z/BgihaOCg5KgeRGVJ845jvqbmtPaBRTOaBk2ZzFPIxqxwCGGGoSXenVddGx4AdrQyIXVcqgAuR6Y8xmCyTU3d4/K7eGOOGe3ah965NJ2CiTxlKeSCA9M3FbR7t2vc= # DEPLOY_PROD_HOST
  - secure: gvGNn4LIxYtHL1Zh6ykJ/Nkkjn8wXinJONWUXcRKnKLFJaYSYUjLM0aCwMr/dC+i5sPNBj1TIdM44yDLmtCqbRi7Zv6BVPpOe6QMsdyjy25/CvSKC4lAK69M0ClXwo7GBzKV+hoTZjXp5mBXw/mzN8K+pOpAYVE13EqEPg4Ld+eclHePAaeAucMFu63GxHrEncc6hhG/Zupy/VZZ/NlOq+Sn7VSaSoHvdABVjqKrubDI9TJb6BXqL0psJZDI9W8b7bKvjFIZ1VbdI/e6HuPlKi7thqTzJ+F04lOiqgJm/TmSnjCKvSkjtjJqkEQrZsqpPv2WwDgqqCb8wgEz2wpD/1TfaxpZZ4asCBSLHuupe5rCL0ml+au0sFL1ganSFxBxBll0iUk3xiyRvE1tWsLLSFew5sv3cBVRc6A3RTmvUnF0C4jUWcYe6JD2rYSmRuY4zM4E5+oVPoDWHJRYNZsUerFYRp3pXKB5/vD7DKyfcjowAMFJrfRTo/7XfD98ljgH82FP5C0ar0EySLcwwY2cp1d8xfG1+hIZk/PlJgPtm5GpAHoiR7i0aYmPO7R0nJpy6F1LWPRgiwAz/kymRACWZdvbVF60BnuGTm7oEI0KYhpgX9GsQdIgwIzBgt4QhgXi8DnoCWi7PpgKylPVL+TEDYczQEVM8/MkjSus0TcgVxQ= # LOGZIO_TOKEN
